name: Release

"on":
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20.18.1

      - uses: pnpm/action-setup@v4
        with:
          version: 10.18.3

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.90.0

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Validate release tag
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME}"
          echo "tag=${tag}"
          if ! echo "$tag" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+([-.].*)?$'; then
            echo "Invalid tag: $tag (expected vMAJOR.MINOR.PATCH)" >&2
            exit 1
          fi

      - name: Set package versions from tag
        run: |
          set -euo pipefail
          export VERSION="${GITHUB_REF_NAME#v}"
          node -e "const fs=require('fs'); const v=process.env.VERSION; for (const p of ['packages/sdk-ts/package.json','packages/cli/package.json']) { const j=JSON.parse(fs.readFileSync(p,'utf8')); j.version=v; fs.writeFileSync(p, JSON.stringify(j,null,2)+'\n'); }"
          python3 - <<'PY'
          import os, re
          v = os.environ['VERSION']
          p = 'crates/sdk-rs/Cargo.toml'
          s = open(p,'r',encoding='utf-8').read()
          s2 = re.sub(r'(?m)^version\s*=\s*"[^"]+"\s*$', f'version = "{v}"', s)
          open(p,'w',encoding='utf-8').write(s2)
          PY

      - name: Build sdk-ts
        run: pnpm -C packages/sdk-ts build

      - name: Package sdk-ts dist
        run: tar -czf noirforge-sdk-ts-dist.tgz -C packages/sdk-ts dist package.json

      - name: Package cli
        run: tar -czf noirforge-cli.tgz -C packages/cli bin package.json

      - name: Package rust crate
        run: |
          set -euo pipefail
          cargo package -p noirforge-sdk --allow-dirty
          crate_file="$(ls -1 target/package/noirforge-sdk-*.crate | head -n 1)"
          cp "$crate_file" noirforge-sdk.crate

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0.16.0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            noirforge-sdk-ts-dist.tgz
            noirforge-cli.tgz
            noirforge-sdk.crate
            sbom.spdx.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            noirforge-sdk-ts-dist.tgz
            noirforge-cli.tgz
            noirforge-sdk.crate
            sbom.spdx.json
