name: Release

"on":
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to release from (tag like v0.1.0-rc.1, refs/tags/v0.1.0-rc.1)"
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write

    steps:
      - name: Resolve release ref
        id: resolve_ref
        shell: bash
        run: |
          set -euo pipefail

          raw="${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}"
          raw="${raw//$'\r'/}"
          raw="${raw//$'\n'/}"
          raw="${raw#ref = }"
          raw="${raw#ref=}"
          raw="${raw# }"
          raw="${raw% }"

          if [[ -z "$raw" ]]; then
            echo "Missing ref" >&2
            exit 1
          fi

          # If a raw tag name is provided, normalize it to refs/tags/<tag>
          if [[ "$raw" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.].*)?$ ]]; then
            tag="$raw"
            ref="refs/tags/$raw"
          elif [[ "$raw" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+([-.].*)?$ ]]; then
            ref="$raw"
            tag="${raw#refs/tags/}"
          else
            echo "Invalid ref: '$raw' (expected vMAJOR.MINOR.PATCH tag or refs/tags/vMAJOR.MINOR.PATCH)" >&2
            exit 1
          fi

          echo "ref=$ref" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.resolve_ref.outputs.ref }}

      - uses: actions/setup-node@v6
        with:
          node-version: 20.18.1

      - uses: pnpm/action-setup@v4
        with: {}

      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.90.0

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Validate release tag
        run: |
          set -euo pipefail
          tag="${{ steps.resolve_ref.outputs.tag }}"
          echo "tag=${tag}"
          if ! echo "$tag" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+([-.].*)?$'; then
            echo "Invalid tag: $tag (expected vMAJOR.MINOR.PATCH)" >&2
            exit 1
          fi

      - name: Set package versions from tag
        run: |
          set -euo pipefail
          export VERSION="${{ steps.resolve_ref.outputs.tag }}"
          export VERSION="${VERSION#v}"
          node -e "const fs=require('fs'); const v=process.env.VERSION; const pkgs=['packages/core/package.json','packages/sdk-ts/package.json','packages/cli/package.json']; for (const p of pkgs) { const j=JSON.parse(fs.readFileSync(p,'utf8')); j.version=v; if ((p.includes('/sdk-ts/')||p.includes('/cli/')) && j.dependencies && j.dependencies['@noirforge/core']) j.dependencies['@noirforge/core']=v; fs.writeFileSync(p, JSON.stringify(j,null,2)+'\\n'); }"
          python3 - <<'PY'
          import os, re
          v = os.environ['VERSION']
          p = 'crates/sdk-rs/Cargo.toml'
          s = open(p,'r',encoding='utf-8').read()
          s2 = re.sub(r'(?m)^version\s*=\s*"[^"]+"\s*$', f'version = "{v}"', s)
          open(p,'w',encoding='utf-8').write(s2)
          PY

      - name: Build sdk-ts
        run: pnpm -C packages/sdk-ts build

      - name: Package sdk-ts dist
        run: tar -czf noirforge-sdk-ts-dist.tgz -C packages/sdk-ts dist package.json

      - name: Package core
        run: tar -czf noirforge-core.tgz -C packages/core index.js index.d.ts package.json

      - name: Package cli
        run: tar -czf noirforge-cli.tgz -C packages/cli bin package.json

      - name: Package rust crate
        run: |
          set -euo pipefail
          cargo package -p noirforge-sdk --allow-dirty
          crate_file="$(ls -1 target/package/noirforge-sdk-*.crate | head -n 1)"
          cp "$crate_file" noirforge-sdk.crate

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0.16.0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v3
        continue-on-error: true
        with:
          subject-path: |
            noirforge-sdk-ts-dist.tgz
            noirforge-core.tgz
            noirforge-cli.tgz
            noirforge-sdk.crate
            sbom.spdx.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve_ref.outputs.tag }}
          generate_release_notes: true
          files: |
            noirforge-sdk-ts-dist.tgz
            noirforge-core.tgz
            noirforge-cli.tgz
            noirforge-sdk.crate
            sbom.spdx.json
